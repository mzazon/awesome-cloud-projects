# Infrastructure as Code for Intelligent Product Search with Cloud SQL and Vertex AI

This directory contains Infrastructure as Code (IaC) implementations for the recipe "Intelligent Product Search with Cloud SQL and Vertex AI". This solution creates a semantic search system using Cloud SQL for MySQL to store product data with vector embeddings generated by Vertex AI's text embedding models.

## Solution Overview

The infrastructure deploys:
- **Cloud SQL for MySQL**: Managed database storing product data and vector embeddings
- **Vertex AI**: Text embedding model (text-embedding-005) for semantic understanding
- **Cloud Functions**: Serverless API for search queries and product ingestion
- **Cloud Storage**: Configuration storage and function deployment
- **IAM Roles**: Secure service-to-service authentication

## Available Implementations

- **Infrastructure Manager**: Google Cloud's managed Terraform service
- **Terraform**: Multi-cloud infrastructure as code using the official Google Cloud provider
- **Scripts**: Bash deployment and cleanup scripts with error handling

## Prerequisites

Before deploying this infrastructure, ensure you have:

- Google Cloud SDK (`gcloud`) installed and configured
- Terraform >= 1.0 installed (for Terraform deployment)
- A Google Cloud project with billing enabled
- The following APIs enabled in your project:
  - Cloud SQL Admin API (`sqladmin.googleapis.com`)
  - Vertex AI API (`aiplatform.googleapis.com`)
  - Cloud Functions API (`cloudfunctions.googleapis.com`)
  - Cloud Storage API (`storage.googleapis.com`)
  - Cloud Build API (`cloudbuild.googleapis.com`)
- Appropriate IAM permissions:
  - Cloud SQL Admin
  - Vertex AI User
  - Cloud Functions Developer
  - Storage Admin
  - Project Editor (or equivalent granular permissions)

### Estimated Costs

Running this infrastructure will incur the following approximate costs:
- **Cloud SQL**: $25-50/month for db-n1-standard-2 instance
- **Cloud Functions**: $0-5/month (generous free tier)
- **Vertex AI API**: $0.001 per 1K tokens (embeddings)
- **Cloud Storage**: $0-2/month for configuration storage

> **Note**: Costs can be minimized during development by using the smallest Cloud SQL instance size and leveraging Cloud Functions' free tier.

## Quick Start

### Using Infrastructure Manager (Recommended for GCP)

Infrastructure Manager is Google Cloud's managed Terraform service that provides state management, collaborative workflows, and drift detection.

```bash
# Set required environment variables
export PROJECT_ID="your-project-id"
export REGION="us-central1"

# Create deployment using Infrastructure Manager
gcloud infra-manager deployments create intelligent-search \
    --location=${REGION} \
    --source=./infrastructure-manager/main.yaml \
    --input-values="project_id=${PROJECT_ID},region=${REGION}" \
    --labels="environment=production,recipe=intelligent-search"

# Monitor deployment status
gcloud infra-manager deployments describe intelligent-search \
    --location=${REGION}
```

### Using Terraform

For maximum flexibility and multi-cloud support, use Terraform directly:

```bash
# Navigate to terraform directory
cd terraform/

# Initialize Terraform
terraform init

# Review the planned changes
terraform plan -var="project_id=${PROJECT_ID}" -var="region=${REGION}"

# Apply the infrastructure
terraform apply -var="project_id=${PROJECT_ID}" -var="region=${REGION}"

# View outputs
terraform output
```

### Using Bash Scripts

For automated deployment with pre-validation:

```bash
# Make scripts executable
chmod +x scripts/deploy.sh scripts/destroy.sh

# Deploy infrastructure with validation
./scripts/deploy.sh

# The script will:
# 1. Validate prerequisites
# 2. Enable required APIs
# 3. Create all infrastructure resources
# 4. Provide deployment summary
```

## Configuration Options

### Variable Customization

All implementations support the following customizable variables:

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `project_id` | Google Cloud Project ID | - | Yes |
| `region` | Primary deployment region | `us-central1` | No |
| `zone` | Deployment zone | `us-central1-a` | No |
| `environment` | Environment name (dev/staging/prod) | `dev` | No |
| `db_tier` | Cloud SQL instance tier | `db-n1-standard-2` | No |
| `function_memory` | Cloud Functions memory allocation | `512MB` | No |
| `enable_backup` | Enable automated Cloud SQL backups | `true` | No |

### Example Customization

```bash
# Terraform with custom variables
terraform apply \
  -var="project_id=my-project" \
  -var="region=us-west1" \
  -var="environment=production" \
  -var="db_tier=db-n1-standard-4" \
  -var="function_memory=1024MB"
```

## Validation and Testing

After deployment, validate the infrastructure:

### 1. Verify Cloud SQL Instance

```bash
# Check instance status
gcloud sql instances describe product-db-${RANDOM_SUFFIX} \
    --format="value(state)"

# Test database connectivity
gcloud sql connect product-db-${RANDOM_SUFFIX} \
    --user=root \
    --database=products
```

### 2. Test Cloud Functions

```bash
# Get function URLs
export SEARCH_URL=$(gcloud functions describe product-search-${RANDOM_SUFFIX} \
    --region=${REGION} \
    --format="value(serviceConfig.uri)")

# Test search functionality
curl -X POST "${SEARCH_URL}" \
    -H "Content-Type: application/json" \
    -d '{"query": "running shoes", "limit": 5}'
```

### 3. Verify Vertex AI Integration

```bash
# Check that embeddings are generated
curl -X POST "${ADD_URL}" \
    -H "Content-Type: application/json" \
    -d '{
        "name": "Test Product",
        "description": "High-quality test product for validation",
        "category": "test",
        "price": 99.99
    }'
```

## Cleanup

### Using Infrastructure Manager

```bash
# Delete the deployment
gcloud infra-manager deployments delete intelligent-search \
    --location=${REGION} \
    --delete-policy="DELETE"

# Verify all resources are removed
gcloud infra-manager deployments list --location=${REGION}
```

### Using Terraform

```bash
cd terraform/
terraform destroy -var="project_id=${PROJECT_ID}" -var="region=${REGION}"
```

### Using Bash Scripts

```bash
# Run cleanup script with confirmation
./scripts/destroy.sh

# The script will:
# 1. List resources to be deleted
# 2. Request confirmation
# 3. Delete resources in correct dependency order
# 4. Verify complete cleanup
```

## Security Considerations

This infrastructure implements several security best practices:

### 1. IAM and Access Control
- Service accounts use principle of least privilege
- Cloud SQL uses IAM database authentication where possible
- Cloud Functions have restricted network access

### 2. Data Protection
- Cloud SQL backups are encrypted at rest
- All data transmission uses TLS
- Vector embeddings are stored securely in Cloud SQL

### 3. Network Security
- Private Google Access is enabled for internal communication
- Cloud Functions can be configured for VPC connectivity
- Cloud SQL uses private IP addressing when possible

### 4. Secrets Management
- Database passwords are generated securely
- Function environment variables use Secret Manager integration
- API keys and credentials are properly rotated

## Troubleshooting

### Common Issues

1. **API Not Enabled Error**
   ```bash
   # Enable required APIs manually
   gcloud services enable sqladmin.googleapis.com aiplatform.googleapis.com
   ```

2. **Insufficient Permissions**
   ```bash
   # Check current permissions
   gcloud auth list
   gcloud projects get-iam-policy ${PROJECT_ID}
   ```

3. **Cloud SQL Connection Issues**
   ```bash
   # Check Cloud SQL Auth Proxy
   gcloud sql instances describe ${INSTANCE_NAME}
   ```

4. **Function Deployment Failures**
   ```bash
   # Check Cloud Build logs
   gcloud builds list --limit=5
   ```

### Performance Optimization

1. **Database Performance**
   - Consider increasing Cloud SQL instance size for large datasets
   - Implement connection pooling for high-traffic scenarios
   - Use read replicas for query-heavy workloads

2. **Function Optimization**
   - Increase memory allocation for faster embedding generation
   - Implement caching for frequently accessed embeddings
   - Use Cloud CDN for static content delivery

3. **Cost Optimization**
   - Use Cloud SQL scheduled scaling for predictable workloads
   - Implement Cloud Functions concurrency controls
   - Enable automatic scaling based on demand metrics

## Monitoring and Observability

The infrastructure includes monitoring capabilities:

### 1. Cloud SQL Monitoring
- Database performance metrics in Cloud Monitoring
- Automated backup monitoring and alerting
- Query performance insights

### 2. Cloud Functions Monitoring
- Execution metrics and error rates
- Cold start monitoring
- Memory and CPU utilization tracking

### 3. Vertex AI Usage Tracking
- API call volume and latency metrics
- Embedding generation success rates
- Cost tracking per API call

### 4. Custom Dashboards
```bash
# Create custom monitoring dashboard
gcloud monitoring dashboards create --config-from-file=monitoring-dashboard.json
```

## Advanced Configuration

### 1. Multi-Region Deployment

For high availability, deploy across multiple regions:

```bash
# Deploy to multiple regions
for region in us-central1 us-west1 us-east1; do
  terraform apply -var="region=${region}" -var="multi_region=true"
done
```

### 2. VPC Integration

Configure private networking:

```yaml
# Infrastructure Manager configuration
network_config:
  enable_private_ip: true
  vpc_network: "projects/${PROJECT_ID}/global/networks/my-vpc"
  subnet: "projects/${PROJECT_ID}/regions/${REGION}/subnetworks/my-subnet"
```

### 3. Custom Embedding Models

Switch to different Vertex AI models:

```bash
terraform apply -var="embedding_model=text-embedding-gecko@003"
```

## Support and Documentation

For additional help and documentation:

- **Google Cloud Documentation**: [Cloud SQL](https://cloud.google.com/sql/docs), [Vertex AI](https://cloud.google.com/vertex-ai/docs), [Cloud Functions](https://cloud.google.com/functions/docs)
- **Terraform Documentation**: [Google Cloud Provider](https://registry.terraform.io/providers/hashicorp/google/latest/docs)
- **Infrastructure Manager**: [Official Documentation](https://cloud.google.com/infrastructure-manager/docs)
- **Recipe Documentation**: Refer to the original recipe markdown for architectural details

## Contributing

When modifying this infrastructure:

1. Test changes in a development environment first
2. Update variable documentation for new parameters
3. Validate Terraform plans before applying
4. Update monitoring and alerting configurations
5. Document any breaking changes in deployment procedures

## License

This infrastructure code is provided as part of the recipe collection and follows the same licensing terms as the parent repository.